use crate::kernel::table::idt::{Flags, InterruptDescriptorTable as IDT};
use lib::sync::*;
use lib::*;

pub static GLOBAL_IDT: Spinlock<IDT> = Spinlock::new(IDT::new());

macro_rules! print_interrupt {
    ($idt:ident, $name:ident, $vector:expr) => {
        isr! {
            fn $name() {
                early_kprintln!("int {} ({})", stringify!($name), $vector);
            }
        }
        
        $idt.set_handler($vector, Flags::PRESENT | Flags::TYPE_INTERRUPT, $name);
    }
}

isr!{
    fn blank_handler() {
        early_kprintln!("blank handler");
    }
}


pub fn setup_idt() {
    let mut idt = GLOBAL_IDT.lock();

    for i in 0..=255 {
        idt.set_handler(i, Flags::PRESENT | Flags::TYPE_INTERRUPT, blank_handler);
    }

    print_interrupt!(idt, int0, 0);
    print_interrupt!(idt, int1, 1);
    print_interrupt!(idt, int2, 2);
    print_interrupt!(idt, int3, 3);
    print_interrupt!(idt, int4, 4);
    print_interrupt!(idt, int5, 5);
    print_interrupt!(idt, int6, 6);
    print_interrupt!(idt, int7, 7);
    print_interrupt!(idt, int8, 8);
    print_interrupt!(idt, int9, 9);
    print_interrupt!(idt, int10, 10);
    print_interrupt!(idt, int11, 11);
    print_interrupt!(idt, int12, 12);
    print_interrupt!(idt, int13, 13);
    print_interrupt!(idt, int14, 14);
    print_interrupt!(idt, int15, 15);
    print_interrupt!(idt, int16, 16);
    print_interrupt!(idt, int17, 17);
    print_interrupt!(idt, int18, 18);
    print_interrupt!(idt, int19, 19);
    print_interrupt!(idt, int20, 20);
    print_interrupt!(idt, int21, 21);
    print_interrupt!(idt, int22, 22);
    print_interrupt!(idt, int23, 23);
    print_interrupt!(idt, int24, 24);
    print_interrupt!(idt, int25, 25);
    print_interrupt!(idt, int26, 26);
    print_interrupt!(idt, int27, 27);
    print_interrupt!(idt, int28, 28);
    print_interrupt!(idt, int29, 29);
    print_interrupt!(idt, int30, 30);
    print_interrupt!(idt, int31, 31);
    print_interrupt!(idt, int32, 32);
    print_interrupt!(idt, int33, 33);
    print_interrupt!(idt, int34, 34);
    print_interrupt!(idt, int35, 35);
    print_interrupt!(idt, int36, 36);
    print_interrupt!(idt, int37, 37);
    print_interrupt!(idt, int38, 38);
    print_interrupt!(idt, int39, 39);
    print_interrupt!(idt, int40, 40);
    print_interrupt!(idt, int41, 41);
    print_interrupt!(idt, int42, 42);
    print_interrupt!(idt, int43, 43);
    print_interrupt!(idt, int44, 44);
    print_interrupt!(idt, int45, 45);
    print_interrupt!(idt, int46, 46);
    print_interrupt!(idt, int47, 47);
    print_interrupt!(idt, int48, 48);
    print_interrupt!(idt, int49, 49);
    print_interrupt!(idt, int50, 50);
    print_interrupt!(idt, int51, 51);
    print_interrupt!(idt, int52, 52);
    print_interrupt!(idt, int53, 53);
    print_interrupt!(idt, int54, 54);
    print_interrupt!(idt, int55, 55);
    print_interrupt!(idt, int56, 56);
    print_interrupt!(idt, int57, 57);
    print_interrupt!(idt, int58, 58);
    print_interrupt!(idt, int59, 59);
    print_interrupt!(idt, int60, 60);
    print_interrupt!(idt, int61, 61);
    print_interrupt!(idt, int62, 62);
    print_interrupt!(idt, int63, 63);
    print_interrupt!(idt, int64, 64);
    print_interrupt!(idt, int65, 65);
    print_interrupt!(idt, int66, 66);
    print_interrupt!(idt, int67, 67);
    print_interrupt!(idt, int68, 68);
    print_interrupt!(idt, int69, 69);
    print_interrupt!(idt, int70, 70);
    print_interrupt!(idt, int71, 71);
    print_interrupt!(idt, int72, 72);
    print_interrupt!(idt, int73, 73);
    print_interrupt!(idt, int74, 74);
    print_interrupt!(idt, int75, 75);
    print_interrupt!(idt, int76, 76);
    print_interrupt!(idt, int77, 77);
    print_interrupt!(idt, int78, 78);
    print_interrupt!(idt, int79, 79);
    print_interrupt!(idt, int80, 80);
    print_interrupt!(idt, int81, 81);
    print_interrupt!(idt, int82, 82);
    print_interrupt!(idt, int83, 83);
    print_interrupt!(idt, int84, 84);
    print_interrupt!(idt, int85, 85);
    print_interrupt!(idt, int86, 86);
    print_interrupt!(idt, int87, 87);
    print_interrupt!(idt, int88, 88);
    print_interrupt!(idt, int89, 89);
    print_interrupt!(idt, int90, 90);
    print_interrupt!(idt, int91, 91);
    print_interrupt!(idt, int92, 92);
    print_interrupt!(idt, int93, 93);
    print_interrupt!(idt, int94, 94);
    print_interrupt!(idt, int95, 95);
    print_interrupt!(idt, int96, 96);
    print_interrupt!(idt, int97, 97);
    print_interrupt!(idt, int98, 98);
    print_interrupt!(idt, int99, 99);
    print_interrupt!(idt, int100, 100);
    print_interrupt!(idt, int101, 101);
    print_interrupt!(idt, int102, 102);
    print_interrupt!(idt, int103, 103);
    print_interrupt!(idt, int104, 104);
    print_interrupt!(idt, int105, 105);
    print_interrupt!(idt, int106, 106);
    print_interrupt!(idt, int107, 107);
    print_interrupt!(idt, int108, 108);
    print_interrupt!(idt, int109, 109);
    print_interrupt!(idt, int110, 110);
    print_interrupt!(idt, int111, 111);
    print_interrupt!(idt, int112, 112);
    print_interrupt!(idt, int113, 113);
    print_interrupt!(idt, int114, 114);
    print_interrupt!(idt, int115, 115);
    print_interrupt!(idt, int116, 116);
    print_interrupt!(idt, int117, 117);
    print_interrupt!(idt, int118, 118);
    print_interrupt!(idt, int119, 119);
    print_interrupt!(idt, int120, 120);
    print_interrupt!(idt, int121, 121);
    print_interrupt!(idt, int122, 122);
    print_interrupt!(idt, int123, 123);
    print_interrupt!(idt, int124, 124);
    print_interrupt!(idt, int125, 125);
    print_interrupt!(idt, int126, 126);
    print_interrupt!(idt, int127, 127);
    print_interrupt!(idt, int128, 128);
    print_interrupt!(idt, int129, 129);
    print_interrupt!(idt, int130, 130);
    print_interrupt!(idt, int131, 131);
    print_interrupt!(idt, int132, 132);
    print_interrupt!(idt, int133, 133);
    print_interrupt!(idt, int134, 134);
    print_interrupt!(idt, int135, 135);
    print_interrupt!(idt, int136, 136);
    print_interrupt!(idt, int137, 137);
    print_interrupt!(idt, int138, 138);
    print_interrupt!(idt, int139, 139);
    print_interrupt!(idt, int140, 140);
    print_interrupt!(idt, int141, 141);
    print_interrupt!(idt, int142, 142);
    print_interrupt!(idt, int143, 143);
    print_interrupt!(idt, int144, 144);
    print_interrupt!(idt, int145, 145);
    print_interrupt!(idt, int146, 146);
    print_interrupt!(idt, int147, 147);
    print_interrupt!(idt, int148, 148);
    print_interrupt!(idt, int149, 149);
    print_interrupt!(idt, int150, 150);
    print_interrupt!(idt, int151, 151);
    print_interrupt!(idt, int152, 152);
    print_interrupt!(idt, int153, 153);
    print_interrupt!(idt, int154, 154);
    print_interrupt!(idt, int155, 155);
    print_interrupt!(idt, int156, 156);
    print_interrupt!(idt, int157, 157);
    print_interrupt!(idt, int158, 158);
    print_interrupt!(idt, int159, 159);
    print_interrupt!(idt, int160, 160);
    print_interrupt!(idt, int161, 161);
    print_interrupt!(idt, int162, 162);
    print_interrupt!(idt, int163, 163);
    print_interrupt!(idt, int164, 164);
    print_interrupt!(idt, int165, 165);
    print_interrupt!(idt, int166, 166);
    print_interrupt!(idt, int167, 167);
    print_interrupt!(idt, int168, 168);
    print_interrupt!(idt, int169, 169);
    print_interrupt!(idt, int170, 170);
    print_interrupt!(idt, int171, 171);
    print_interrupt!(idt, int172, 172);
    print_interrupt!(idt, int173, 173);
    print_interrupt!(idt, int174, 174);
    print_interrupt!(idt, int175, 175);
    print_interrupt!(idt, int176, 176);
    print_interrupt!(idt, int177, 177);
    print_interrupt!(idt, int178, 178);
    print_interrupt!(idt, int179, 179);
    print_interrupt!(idt, int180, 180);
    print_interrupt!(idt, int181, 181);
    print_interrupt!(idt, int182, 182);
    print_interrupt!(idt, int183, 183);
    print_interrupt!(idt, int184, 184);
    print_interrupt!(idt, int185, 185);
    print_interrupt!(idt, int186, 186);
    print_interrupt!(idt, int187, 187);
    print_interrupt!(idt, int188, 188);
    print_interrupt!(idt, int189, 189);
    print_interrupt!(idt, int190, 190);
    print_interrupt!(idt, int191, 191);
    print_interrupt!(idt, int192, 192);
    print_interrupt!(idt, int193, 193);
    print_interrupt!(idt, int194, 194);
    print_interrupt!(idt, int195, 195);
    print_interrupt!(idt, int196, 196);
    print_interrupt!(idt, int197, 197);
    print_interrupt!(idt, int198, 198);
    print_interrupt!(idt, int199, 199);
    print_interrupt!(idt, int200, 200);
    print_interrupt!(idt, int201, 201);
    print_interrupt!(idt, int202, 202);
    print_interrupt!(idt, int203, 203);
    print_interrupt!(idt, int204, 204);
    print_interrupt!(idt, int205, 205);
    print_interrupt!(idt, int206, 206);
    print_interrupt!(idt, int207, 207);
    print_interrupt!(idt, int208, 208);
    print_interrupt!(idt, int209, 209);
    print_interrupt!(idt, int210, 210);
    print_interrupt!(idt, int211, 211);
    print_interrupt!(idt, int212, 212);
    print_interrupt!(idt, int213, 213);
    print_interrupt!(idt, int214, 214);
    print_interrupt!(idt, int215, 215);
    print_interrupt!(idt, int216, 216);
    print_interrupt!(idt, int217, 217);
    print_interrupt!(idt, int218, 218);
    print_interrupt!(idt, int219, 219);
    print_interrupt!(idt, int220, 220);
    print_interrupt!(idt, int221, 221);
    print_interrupt!(idt, int222, 222);
    print_interrupt!(idt, int223, 223);
    print_interrupt!(idt, int224, 224);
    print_interrupt!(idt, int225, 225);
    print_interrupt!(idt, int226, 226);
    print_interrupt!(idt, int227, 227);
    print_interrupt!(idt, int228, 228);
    print_interrupt!(idt, int229, 229);
    print_interrupt!(idt, int230, 230);
    print_interrupt!(idt, int231, 231);
    print_interrupt!(idt, int232, 232);
    print_interrupt!(idt, int233, 233);
    print_interrupt!(idt, int234, 234);
    print_interrupt!(idt, int235, 235);
    print_interrupt!(idt, int236, 236);
    print_interrupt!(idt, int237, 237);
    print_interrupt!(idt, int238, 238);
    print_interrupt!(idt, int239, 239);
    print_interrupt!(idt, int240, 240);
    print_interrupt!(idt, int241, 241);
    print_interrupt!(idt, int242, 242);
    print_interrupt!(idt, int243, 243);
    print_interrupt!(idt, int244, 244);
    print_interrupt!(idt, int245, 245);
    print_interrupt!(idt, int246, 246);
    print_interrupt!(idt, int247, 247);
    print_interrupt!(idt, int248, 248);
    print_interrupt!(idt, int249, 249);
    print_interrupt!(idt, int250, 250);
    print_interrupt!(idt, int251, 251);
    print_interrupt!(idt, int252, 252);
    print_interrupt!(idt, int253, 253);
    print_interrupt!(idt, int254, 254);
    print_interrupt!(idt, int255, 255);

    unsafe {
        idt.load();
        enable_interrupts!();
    };
}

